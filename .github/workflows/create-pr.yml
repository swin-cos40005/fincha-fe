name: Automatically create / update pull request

on:
  push:
    branches-ignore:
      - "main"
      - "dependabot/**"

concurrency:
  group: create-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  create_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Format branch name as title
        id: branch
        run: |
          BRANCH="${{ github.ref_name }}"
          TITLE=$(echo "$BRANCH" | sed 's/[\/\-_]/ /g' | sed 's/ *#[0-9]*$//')
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "${{ github.ref_name }}" --json number --jq '.[0].number')
          
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base main \
              --head "${{ github.ref_name }}" \
              --title "${{ steps.branch.outputs.title }}" \
              --body-file ".github/PULL_REQUEST_TEMPLATE.md" \
              --draft
          fi
